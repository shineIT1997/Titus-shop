{% extends  'layout.njk' %}

{% block sidebar %}
  {% include 'partials/sidebar/sidebar.njk' %}
{% endblock %}


{% block style %}
<style>
  .button-wrapper {
    position: relative;
    width: 150px;
    text-align: center;
    margin: 8px 0;
  }

  .upload-box {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
  }

  .button-wrapper span.label {
    position: relative;
    z-index: 0;
    display: inline-block;
    width: 100%;
    background: #00bfff;
    cursor: pointer;
    color: #fff;
    padding: 10px 0;
    text-transform:uppercase;
    font-size:12px;
  }

  #upload {
      display: inline-block;
      position: absolute;
      z-index: 1;
      width: 100%;
      height: 50px;
      top: 0;
      left: 0;
      opacity: 0;
      cursor: pointer;
  }

  .imageBox {
    position: relative;
    margin:8px;
  }

  .image-thumbnail {
    padding: .25rem;
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: .25rem;
  }

  .removeImage {
    position: absolute;
    top: 0;
    right: 0;
  }

  img {
    height: 200px;
  }
</style>
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-2 pb-2 mb-3 border-bottom">
  <h1 class="h2">Thêm Phong Cách</h1>
</div>
    {% if success %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <p class="mb-0">{{success}}</p>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endif %}

    {% if errors %}
      <div class="alert alert-danger alert-dismissible fade show" role="alert">         
        {% for msg in errors %}
          <p class="mb-0">{{msg}}</p>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        {% endfor %} 
      </div>
    {% endif %}


<div class="row" style="padding: 16px">
    <div class="col-md-12 px-20">
      <h5 class="mb-3">Thông tin cơ bản</h5>
      <form id="formProduct" action="{{'/news/' + news._id + '/update.html'}}" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
        <div class="row g-3">          
          <div class="col-sm-12">
            <label for="title" class="form-label">
              Tiêu đề
              <span class="text-danger">(bắc buộc)</span>
            </label>
            <input type="text" class="form-control" id="title" name="title" placeholder="" value="{{news.title}}" required="">
            <div class="invalid-feedback">
              Tiêu đề không hợp lệ
            </div>
          </div>

          <div class="col-sm-12">
            <label for="baseImage" class="form-label">
              Hình ảnh đại diện
              <span class="text-danger">(bắc buộc)</span>
            </label>
            <div class="button-wrapper">
              <span class="label">
                Upload file
              </span>
              <input  id="baseImage" type="file" name="baseImage" class="upload-box" placeholder="Upload File">
            </div>

            <div class="d-flex flex-wrap justify-content-start" id="baseImagePreview">  
              <div class="imageBox">
                <button type="button" onclick="deleteBaseImage(event)" class="btn-close removeImage" ></button>
                <img src={{"/upload/news/" + news.imagePath}} alt="{{news.title}}">
              </div>
            </div>
          </div>

          <div class="col-sm-12">
            <label for="name" class="form-label">
              Nội dung
              <span class="text-danger">(bắc buộc)</span>
            </label>
            <textarea type="text" class="form-control" id="content" name="content" placeholder="" value="" required=""></textarea>
            <div class="invalid-feedback">
              Nội dung không hợp lệ
            </div>
          </div>

            <hr class="my-4">
            <div class="row g-3">  
              <h5 class="my-3">Thông tin SEO</h5>
            </div>

              <div class="col-sm-12 mt-3">
                <label for="metaTitle" class="form-label">Tiêu đề meta</label>
                <input type="text" class="form-control" id="metaTitle" name="metaTitle" placeholder="" value="{{news.metaTitle}}">
              </div>

              <div class="col-sm-12 mt-3">
                <label for="metaKeywords" class="form-label">Meta Keywords</label>
                <input type="text" class="form-control" id="metaKeywords" name="metaKeywords" placeholder="" value="{{news.metaKeywords}}">
              </div>

              <div class="col-sm-12 mt-3">
                <label for="metaDescription" class="form-label">Mô tả Meta</label>
                <textarea row="5" class="form-control" id="metaDescription" value="{{news.metaDescription}}" name="metaDescription"></textarea>
              </div>
          
          <hr class="my-4">
          <div class="col-sm-4 d-flex ms-auto">
            <button class=" ms-auto w-10 btn btn-primary btn-lg align-self-end" type="submit">Cập nhật</button>
          </div>

      </form>
    </div>

</div>
{% endblock %}

{% block footer %}
  <script language="JavaScript">
    document.querySelector("#news-collapse").classList = "collapse show"
    document.querySelector('button[data-bs-target="#news-collapse"]').classList = "btn btn-toggle align-items-center rounded collapsed activeNav"
    
    const baseImage = document.querySelector('#baseImage');
    const baseImagePreview = document.querySelector('#baseImagePreview');

    function htmlDecode(input){
      var e = document.createElement('div');
      e.innerHTML = input;
      return e.childNodes[0].nodeValue;
    }

    CKEDITOR.replace( document.querySelector( '#content' ), {
        extraPlugin: "filebrowser",
        filebrowserBrowseUrl: "/list/news",
        filebrowserUploadMethod: "form",
        filebrowserUploadUrl: "/news/upload"
      } ).setData(htmlDecode("{{news.body}}"))


    const forms = document.querySelectorAll('.needs-validation')
    
    Array.prototype.slice.call(forms)
      .forEach(function (form) {
        form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }

        form.classList.add('was-validated')
      }, false)
    })

    function previewBaseImage() {
      if (this.files) {

        const file = this.files[0]
        if(!file) return;
        
        const reader = new FileReader();
        
        reader.addEventListener("load", function() {
          const image = new Image();
          image.height = 124;
          image.title  = file.name;
          image.src    = this.result;
          image.alt    = file.name;
          image.classList= 'image-thumbnail'

          baseImagePreview.innerHTML ="";

          const imageBox = document.createElement("div");
          imageBox.classList = "imageBox"

          const removeIcon = document.createElement("button");
          removeIcon.classList= "btn-close removeImage";
          removeIcon.type= "button";
          removeIcon.name= image.title;
          removeIcon.onclick = deleteBaseImage;
          

          imageBox.appendChild(image)
          imageBox.appendChild(removeIcon)

          baseImagePreview.appendChild(imageBox);
        });
        
        reader.readAsDataURL(file);
      }
    }

      function deleteBaseImage(event , index) {
        baseImage.value =""
        event.target.parentElement.remove()
      }

    document.querySelector('#baseImage').addEventListener("change", previewBaseImage);

  </script>
{% endblock %}